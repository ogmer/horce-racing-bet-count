---
/**
 * フォーメーション計算コンポーネント
 * 各買い目で選んだ馬の点数を計算する
 */
import { getAllBetTypes, formatYenAmount } from '../utils/betCalculations';

export interface Props {
  unitAmount?: number;
  className?: string;
}

const { 
  unitAmount = 100,
  className = '' 
} = Astro.props;

const allBetTypes = getAllBetTypes();
// 単勝・複勝を除外
const betTypes = allBetTypes.filter(bt => bt.id !== 'tansho' && bt.id !== 'fukusho');

// 枠の色定義
const frameColors = [
  { num: 1, bg: 'bg-white', border: 'border-gray-300' },
  { num: 2, bg: 'bg-gray-300', border: 'border-gray-400' },
  { num: 3, bg: 'bg-red-200', border: 'border-red-300' },
  { num: 4, bg: 'bg-blue-200', border: 'border-blue-300' },
  { num: 5, bg: 'bg-yellow-200', border: 'border-yellow-300' },
  { num: 6, bg: 'bg-green-200', border: 'border-green-300' },
  { num: 7, bg: 'bg-orange-200', border: 'border-orange-300' },
  { num: 8, bg: 'bg-pink-200', border: 'border-pink-300' },
];
---

<div class={`formation-calculator ${className}`}>
  <h2 class="text-xl font-bold text-gray-800 mb-4">フォーメーション計算</h2>
  
  <div class="formation-section p-4 bg-white border-2 border-gray-200 rounded-lg">
    <!-- フォーメーションテーブル -->
    <div class="formation-table-container">
      <div class="table-wrapper overflow-x-auto">
        <table class="formation-table w-full border-collapse border border-gray-300">
          <thead>
            <!-- 枠ヘッダー行 -->
            <tr>
              <th class="px-3 py-2 border border-gray-300 bg-gray-100 font-bold text-sm">枠</th>
              {Array.from({ length: 8 }, (_, i) => {
                const frameNum = i + 1;
                const frameColor = frameColors[i];
                return (
                  <th class={`px-3 py-2 border border-gray-300 font-bold text-sm ${frameColor.bg} ${frameColor.border}`}>
                    {frameNum}
                  </th>
                );
              })}
              <th class="px-3 py-2 border border-gray-300 bg-gray-100 font-bold text-sm">
                <button
                  type="button"
                  class="select-all-button w-full px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
                  data-select-all="all"
                >
                  全頭
                </button>
              </th>
              <th class="px-3 py-2 border border-gray-300 bg-gray-100 font-bold text-sm">
                <button
                  type="button"
                  class="clear-all-button w-full px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors"
                  data-clear-all="all"
                >
                  全消
                </button>
              </th>
            </tr>
            <!-- 馬番ヘッダー行 -->
            <tr>
              <th class="px-3 py-2 border border-gray-300 bg-gray-100 font-semibold text-sm">馬番</th>
              {Array.from({ length: 8 }, (_, i) => (
                <th class="px-3 py-2 border border-gray-300 bg-white font-semibold text-sm">
                  {i + 1}
                </th>
              ))}
              <th class="px-3 py-2 border border-gray-300 bg-gray-100 font-semibold text-sm">全</th>
              <th class="px-3 py-2 border border-gray-300 bg-gray-100 font-semibold text-sm">消</th>
            </tr>
          </thead>
          <tbody data-horse-rows="all">
            {Array.from({ length: 3 }, (_, i) => {
              const position = i + 1;
              return (
                <tr
                  class="horse-row"
                  data-position={position}
                >
                  <td class="px-3 py-2 border border-gray-300 bg-gray-50 font-medium text-sm">
                    {position}頭目
                  </td>
                  {Array.from({ length: 8 }, (_, j) => (
                    <td class="px-3 py-2 border border-gray-300 text-center">
                      <input
                        type="checkbox"
                        class="horse-checkbox w-5 h-5 cursor-pointer"
                        data-horse-num={j + 1}
                        data-position={position}
                      />
                    </td>
                  ))}
                  <td class="px-3 py-2 border border-gray-300 text-center">
                    <button
                      type="button"
                      class="select-row-button px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors text-sm"
                      data-position={position}
                    >
                      全
                    </button>
                  </td>
                  <td class="px-3 py-2 border border-gray-300 text-center">
                    <button
                      type="button"
                      class="clear-row-button px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm"
                      data-position={position}
                    >
                      消
                    </button>
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
    </div>

    <!-- 計算結果 -->
    <div class="calculation-results mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      {betTypes.map((betType) => (
        <div class="calculation-result">
          <div class="result-display p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="text-sm text-blue-600 font-medium mb-1">{betType.displayName}</div>
            <div class="points-result text-lg font-bold text-blue-800" data-result={betType.id}>
              0点
            </div>
            <div class="amount-result text-sm text-green-600 mt-1" data-amount={betType.id}>
            </div>
          </div>
        </div>
      ))}
    </div>
  </div>
</div>

<script>
  import { formatYenAmount, getMinimumHorseCount } from '../utils/betCalculations';

  class FormationCalculator {
    private container: HTMLElement;
    private unitAmount: number = 100;
    private selections: Map<number, Set<number>> = new Map(); // position -> Set<horseNum>

    constructor(container: HTMLElement) {
      this.container = container;
      this.init();
    }

    private init(): void {
      // 金額変更イベントをリッスン
      document.addEventListener('amountChange', (event: any) => {
        if (event.detail && typeof event.detail.amount === 'number') {
          this.unitAmount = event.detail.amount;
          this.updateAllCalculations();
        }
      });

      // 全選択ボタン
      const selectAllButton = this.container.querySelector('[data-select-all="all"]');
      if (selectAllButton) {
        selectAllButton.addEventListener('click', () => {
          this.selectAllHorses();
        });
      }

      // 全消ボタン
      const clearAllButton = this.container.querySelector('[data-clear-all="all"]');
      if (clearAllButton) {
        clearAllButton.addEventListener('click', () => {
          this.clearAllHorses();
        });
      }

      // チェックボックス
      const checkboxes = this.container.querySelectorAll('.horse-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const position = parseInt(checkbox.getAttribute('data-position') || '0');
          const horseNum = parseInt(checkbox.getAttribute('data-horse-num') || '0');
          this.toggleHorse(position, horseNum, (checkbox as HTMLInputElement).checked);
        });
      });

      // 行選択ボタン
      const selectRowButtons = this.container.querySelectorAll('.select-row-button');
      selectRowButtons.forEach(button => {
        button.addEventListener('click', () => {
          const position = parseInt(button.getAttribute('data-position') || '0');
          this.selectRow(position);
        });
      });

      // 行クリアボタン
      const clearRowButtons = this.container.querySelectorAll('.clear-row-button');
      clearRowButtons.forEach(button => {
        button.addEventListener('click', () => {
          const position = parseInt(button.getAttribute('data-position') || '0');
          this.clearRow(position);
        });
      });

      // 初期表示を更新
      this.updateAllCalculations();
    }

    private toggleHorse(position: number, horseNum: number, checked: boolean): void {
      if (!this.selections.has(position)) {
        this.selections.set(position, new Set());
      }

      const selection = this.selections.get(position)!;
      if (checked) {
        selection.add(horseNum);
      } else {
        selection.delete(horseNum);
      }

      this.updateAllCalculations();
    }

    private selectAllHorses(): void {
      for (let pos = 1; pos <= 3; pos++) {
        if (!this.selections.has(pos)) {
          this.selections.set(pos, new Set());
        }
        const selection = this.selections.get(pos)!;
        for (let num = 1; num <= 8; num++) {
          selection.add(num);
        }
      }

      this.updateCheckboxes();
      this.updateAllCalculations();
    }

    private clearAllHorses(): void {
      this.selections.clear();
      this.updateCheckboxes();
      this.updateAllCalculations();
    }

    private selectRow(position: number): void {
      if (!this.selections.has(position)) {
        this.selections.set(position, new Set());
      }

      const selection = this.selections.get(position)!;
      for (let num = 1; num <= 8; num++) {
        selection.add(num);
      }

      this.updateCheckboxes();
      this.updateAllCalculations();
    }

    private clearRow(position: number): void {
      this.selections.delete(position);
      this.updateCheckboxes();
      this.updateAllCalculations();
    }

    private updateCheckboxes(): void {
      const checkboxes = this.container.querySelectorAll('.horse-checkbox');
      checkboxes.forEach(checkbox => {
        const position = parseInt(checkbox.getAttribute('data-position') || '0');
        const horseNum = parseInt(checkbox.getAttribute('data-horse-num') || '0');
        const selection = this.selections.get(position);
        (checkbox as HTMLInputElement).checked = selection ? selection.has(horseNum) : false;
      });
    }

    private calculateForBetType(betTypeId: string): void {
      const minCount = getMinimumHorseCount(betTypeId);
      const maxCount = betTypeId === 'sanrenpuku' || betTypeId === 'sanrentan' ? 3 : 2;

      const resultDisplay = this.container.querySelector(`[data-result="${betTypeId}"]`) as HTMLElement;
      const amountDisplay = this.container.querySelector(`[data-amount="${betTypeId}"]`) as HTMLElement;

      // 選択された馬を確認
      const selectedPositions: number[][] = [];
      for (let pos = 1; pos <= maxCount; pos++) {
        const selection = this.selections.get(pos);
        if (!selection || selection.size === 0) {
          if (resultDisplay) resultDisplay.textContent = '0点';
          if (amountDisplay) amountDisplay.textContent = '';
          return;
        }
        selectedPositions.push(Array.from(selection).sort((a, b) => a - b));
      }

      // 点数を計算
      const points = this.calculateFormationPoints(betTypeId, selectedPositions);
      const totalAmount = points * this.unitAmount;

      if (resultDisplay) {
        resultDisplay.textContent = `${points}点`;
      }
      if (amountDisplay) {
        amountDisplay.textContent = `合計金額: ${formatYenAmount(totalAmount)}`;
      }
    }

    private calculateFormationPoints(betTypeId: string, selectedPositions: number[][]): number {
      if (selectedPositions.length === 0) return 0;

      // 2頭買いの場合（馬連、馬単など）
      if (selectedPositions.length === 2) {
        const [first, second] = selectedPositions;
        
        if (betTypeId === 'umatan' || betTypeId === 'wakuren') {
          // 馬単・枠連：順序あり（順列）
          return first.length * second.length;
        } else {
          // 馬連・ワイド：順序なし（組み合わせ、ただし重複を除く）
          let count = 0;
          first.forEach(f => {
            second.forEach(s => {
              if (f !== s) count++;
            });
          });
          return count;
        }
      }

      // 3頭買いの場合（3連複、3連単）
      if (selectedPositions.length === 3) {
        const [first, second, third] = selectedPositions;
        
        if (betTypeId === 'sanrentan') {
          // 3連単：順序あり（順列）
          return first.length * second.length * third.length;
        } else {
          // 3連複：順序なし（組み合わせ、重複を除く）
          let count = 0;
          first.forEach(f => {
            second.forEach(s => {
              if (f !== s) {
                third.forEach(t => {
                  if (t !== f && t !== s) count++;
                });
              }
            });
          });
          return count;
        }
      }

      return 0;
    }

    private updateAllCalculations(): void {
      const betTypes = ['wakuren', 'umaren', 'umatan', 'wide', 'sanrenpuku', 'sanrentan'];
      betTypes.forEach(betTypeId => {
        this.calculateForBetType(betTypeId);
      });
    }
  }

  // コンポーネントの初期化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFormationCalculators);
  } else {
    initFormationCalculators();
  }

  function initFormationCalculators(): void {
    const calculators = document.querySelectorAll('.formation-calculator');
    calculators.forEach(calculator => {
      new FormationCalculator(calculator as HTMLElement);
    });
  }
</script>

<style>
  .formation-table {
    min-width: 600px;
  }

  .formation-table th,
  .formation-table td {
    white-space: nowrap;
  }

  .formation-table tbody tr:hover {
    background-color: #f9fafb;
  }

  .horse-checkbox:checked {
    accent-color: #3b82f6;
  }
</style>
