---
/**
 * フォーメーション計算コンポーネント
 * 各買い目で選んだ馬の点数を計算する
 */
import { getAllBetTypes, formatYenAmount } from '../utils/betCalculations';

export interface Props {
  unitAmount?: number;
  className?: string;
}

const { 
  unitAmount = 100,
  className = '' 
} = Astro.props;

const allBetTypes = getAllBetTypes();
// 単勝・複勝を除外
const betTypes = allBetTypes.filter(bt => bt.id !== 'tansho' && bt.id !== 'fukusho');

// 枠の色定義
const frameColors = [
  { num: 1, bg: 'bg-white', border: 'border-gray-300' },
  { num: 2, bg: 'bg-gray-300', border: 'border-gray-400' },
  { num: 3, bg: 'bg-red-200', border: 'border-red-300' },
  { num: 4, bg: 'bg-blue-200', border: 'border-blue-300' },
  { num: 5, bg: 'bg-yellow-200', border: 'border-yellow-300' },
  { num: 6, bg: 'bg-green-200', border: 'border-green-300' },
  { num: 7, bg: 'bg-orange-200', border: 'border-orange-300' },
  { num: 8, bg: 'bg-pink-200', border: 'border-pink-300' },
];
---

<div class={`formation-calculator ${className}`}>
  <h2 class="text-xl font-bold text-gray-800 mb-4">フォーメーション計算</h2>
  
  <div class="formation-section p-4 bg-white border-2 border-gray-200 rounded-lg">
    <!-- フォーメーションテーブル -->
    <div class="formation-table-container">
      <div class="table-wrapper overflow-x-auto">
        <table class="formation-table w-full border-collapse border border-gray-300">
          <thead>
            <!-- 枠ヘッダー行 -->
            <tr>
              <th class="px-3 py-2 border border-gray-300 bg-gray-100 font-bold text-sm">枠</th>
              <!-- 1枠: 1-2番 -->
              <th colspan="2" class={`px-3 py-2 border border-gray-300 font-bold text-sm ${frameColors[0].bg} ${frameColors[0].border}`}>
                1
              </th>
              <!-- 2枠: 3-4番 -->
              <th colspan="2" class={`px-3 py-2 border border-gray-300 font-bold text-sm ${frameColors[1].bg} ${frameColors[1].border}`}>
                2
              </th>
              <!-- 3枠: 5-6番 -->
              <th colspan="2" class={`px-3 py-2 border border-gray-300 font-bold text-sm ${frameColors[2].bg} ${frameColors[2].border}`}>
                3
              </th>
              <!-- 4枠: 7-8番 -->
              <th colspan="2" class={`px-3 py-2 border border-gray-300 font-bold text-sm ${frameColors[3].bg} ${frameColors[3].border}`}>
                4
              </th>
              <!-- 5枠: 9-10番 -->
              <th colspan="2" class={`px-3 py-2 border border-gray-300 font-bold text-sm ${frameColors[4].bg} ${frameColors[4].border}`}>
                5
              </th>
              <!-- 6枠: 11-12番 -->
              <th colspan="2" class={`px-3 py-2 border border-gray-300 font-bold text-sm ${frameColors[5].bg} ${frameColors[5].border}`}>
                6
              </th>
              <!-- 7枠: 13-15番 -->
              <th colspan="3" class={`px-3 py-2 border border-gray-300 font-bold text-sm ${frameColors[6].bg} ${frameColors[6].border}`}>
                7
              </th>
              <!-- 8枠: 16-18番 -->
              <th colspan="3" class={`px-3 py-2 border border-gray-300 font-bold text-sm ${frameColors[7].bg} ${frameColors[7].border}`}>
                8
              </th>
              <th class="px-3 py-2 border border-gray-300 bg-gray-100 font-bold text-sm">
                <button
                  type="button"
                  class="select-all-button w-full px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
                  data-select-all="all"
                >
                  全頭
                </button>
              </th>
              <th class="px-3 py-2 border border-gray-300 bg-gray-100 font-bold text-sm">
                <button
                  type="button"
                  class="clear-all-button w-full px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors"
                  data-clear-all="all"
                >
                  全消
                </button>
              </th>
            </tr>
            <!-- 馬番ヘッダー行 -->
            <tr>
              <th class="px-3 py-2 border border-gray-300 bg-gray-100 font-semibold text-sm">馬番</th>
              {Array.from({ length: 18 }, (_, i) => (
                <th class="px-3 py-2 border border-gray-300 bg-white font-semibold text-sm">
                  {i + 1}
                </th>
              ))}
              <th class="px-3 py-2 border border-gray-300 bg-gray-100 font-semibold text-sm">全</th>
              <th class="px-3 py-2 border border-gray-300 bg-gray-100 font-semibold text-sm">消</th>
            </tr>
          </thead>
          <tbody data-horse-rows="all">
            {Array.from({ length: 3 }, (_, i) => {
              const position = i + 1;
              return (
                <tr
                  class="horse-row"
                  data-position={position}
                >
                  <td class="px-3 py-2 border border-gray-300 bg-gray-50 font-medium text-sm">
                    {position}着・{position}頭目
                  </td>
                  {Array.from({ length: 18 }, (_, j) => (
                    <td class="px-3 py-2 border border-gray-300 text-center">
                      <input
                        type="checkbox"
                        class="horse-checkbox w-5 h-5 cursor-pointer"
                        data-horse-num={j + 1}
                        data-position={position}
                      />
                    </td>
                  ))}
                  <td class="px-3 py-2 border border-gray-300 text-center">
                    <button
                      type="button"
                      class="select-row-button px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors text-sm"
                      data-position={position}
                    >
                      全
                    </button>
                  </td>
                  <td class="px-3 py-2 border border-gray-300 text-center">
                    <button
                      type="button"
                      class="clear-row-button px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm"
                      data-position={position}
                    >
                      消
                    </button>
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
    </div>

    <!-- 計算結果 -->
    <div class="calculation-results mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      {betTypes.map((betType) => (
        <div class="calculation-result">
          <div class="result-display p-3 bg-white border border-gray-200 rounded-lg">
            <div class="text-sm text-gray-700 font-medium mb-1">{betType.displayName}</div>
            <div class="points-result text-lg font-bold text-blue-600" data-result={betType.id}>
              0点
            </div>
            <div class="amount-result text-sm text-green-600 mt-1" data-amount={betType.id}>
            </div>
          </div>
        </div>
      ))}
    </div>
  </div>
</div>

<script>
  import { formatYenAmount, getMinimumHorseCount } from '../utils/betCalculations';
  import { 
    getHistory, 
    saveHistory, 
    generateHistoryId,
    type CalculationHistory
  } from '../utils/historyStorage';

  class FormationCalculator {
    private container: HTMLElement;
    private unitAmount: number = 100;
    private selections: Map<number, Set<number>> = new Map(); // position -> Set<horseNum>
    private historySaveTimeout: number | null = null;

    constructor(container: HTMLElement) {
      this.container = container;
      this.init();
    }

    private init(): void {
      // 金額変更イベントをリッスン
      document.addEventListener('amountChange', (event: any) => {
        if (event.detail && typeof event.detail.amount === 'number') {
          this.unitAmount = event.detail.amount;
          this.updateAllCalculations();
        }
      });

      // 全選択ボタン
      const selectAllButton = this.container.querySelector('[data-select-all="all"]');
      if (selectAllButton) {
        selectAllButton.addEventListener('click', () => {
          this.selectAllHorses();
        });
      }

      // 全消ボタン
      const clearAllButton = this.container.querySelector('[data-clear-all="all"]');
      if (clearAllButton) {
        clearAllButton.addEventListener('click', () => {
          this.clearAllHorses();
        });
      }

      // チェックボックス
      const checkboxes = this.container.querySelectorAll('.horse-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const position = parseInt(checkbox.getAttribute('data-position') || '0');
          const horseNum = parseInt(checkbox.getAttribute('data-horse-num') || '0');
          this.toggleHorse(position, horseNum, (checkbox as HTMLInputElement).checked);
        });
      });

      // 行選択ボタン
      const selectRowButtons = this.container.querySelectorAll('.select-row-button');
      selectRowButtons.forEach(button => {
        button.addEventListener('click', () => {
          const position = parseInt(button.getAttribute('data-position') || '0');
          this.selectRow(position);
        });
      });

      // 行クリアボタン
      const clearRowButtons = this.container.querySelectorAll('.clear-row-button');
      clearRowButtons.forEach(button => {
        button.addEventListener('click', () => {
          const position = parseInt(button.getAttribute('data-position') || '0');
          this.clearRow(position);
        });
      });

      // 初期表示を更新
      this.updateAllCalculations();

      // キャッシュから復元
      this.restoreFromCache();
    }

    private toggleHorse(position: number, horseNum: number, checked: boolean): void {
      if (!this.selections.has(position)) {
        this.selections.set(position, new Set());
      }

      const selection = this.selections.get(position)!;
      if (checked) {
        selection.add(horseNum);
      } else {
        selection.delete(horseNum);
      }

      this.updateAllCalculations();
      
      // 履歴を保存（デバウンス）
      this.saveToHistoryDebounced();
    }

    private selectAllHorses(): void {
      for (let pos = 1; pos <= 3; pos++) {
        if (!this.selections.has(pos)) {
          this.selections.set(pos, new Set());
        }
        const selection = this.selections.get(pos)!;
        for (let num = 1; num <= 18; num++) {
          selection.add(num);
        }
      }

      this.updateCheckboxes();
      this.updateAllCalculations();
      this.saveToHistoryDebounced();
    }

    private clearAllHorses(): void {
      this.selections.clear();
      this.updateCheckboxes();
      this.updateAllCalculations();
      // クリア時は履歴を保存しない
    }

    private selectRow(position: number): void {
      if (!this.selections.has(position)) {
        this.selections.set(position, new Set());
      }

      const selection = this.selections.get(position)!;
      for (let num = 1; num <= 18; num++) {
        selection.add(num);
      }

      this.updateCheckboxes();
      this.updateAllCalculations();
      this.saveToHistoryDebounced();
    }

    private clearRow(position: number): void {
      this.selections.delete(position);
      this.updateCheckboxes();
      this.updateAllCalculations();
      this.saveToHistoryDebounced();
    }

    private updateCheckboxes(): void {
      const checkboxes = this.container.querySelectorAll('.horse-checkbox');
      checkboxes.forEach(checkbox => {
        const position = parseInt(checkbox.getAttribute('data-position') || '0');
        const horseNum = parseInt(checkbox.getAttribute('data-horse-num') || '0');
        const selection = this.selections.get(position);
        (checkbox as HTMLInputElement).checked = selection ? selection.has(horseNum) : false;
      });
    }

    private calculateForBetType(betTypeId: string): void {
      const minCount = getMinimumHorseCount(betTypeId);
      const maxCount = betTypeId === 'sanrenpuku' || betTypeId === 'sanrentan' ? 3 : 2;

      const resultDisplay = this.container.querySelector(`[data-result="${betTypeId}"]`) as HTMLElement;
      const amountDisplay = this.container.querySelector(`[data-amount="${betTypeId}"]`) as HTMLElement;

      // 選択された馬を確認
      const selectedPositions: number[][] = [];
      for (let pos = 1; pos <= maxCount; pos++) {
        const selection = this.selections.get(pos);
        if (!selection || selection.size === 0) {
          if (resultDisplay) resultDisplay.textContent = '0点';
          if (amountDisplay) amountDisplay.textContent = '';
          return;
        }
        selectedPositions.push(Array.from(selection).sort((a, b) => a - b));
      }

      // 点数を計算
      const points = this.calculateFormationPoints(betTypeId, selectedPositions);
      const totalAmount = points * this.unitAmount;

      if (resultDisplay) {
        resultDisplay.textContent = `${points}点`;
      }
      if (amountDisplay) {
        amountDisplay.textContent = `合計金額: ${formatYenAmount(totalAmount)}`;
      }
    }

    /**
     * 馬番から枠番を取得する
     * 1-2: 1枠, 3-4: 2枠, 5-6: 3枠, 7-8: 4枠, 9-10: 5枠, 11-12: 6枠, 13-15: 7枠, 16-18: 8枠
     */
    private getFrameNumber(horseNum: number): number {
      if (horseNum <= 2) return 1;
      if (horseNum <= 4) return 2;
      if (horseNum <= 6) return 3;
      if (horseNum <= 8) return 4;
      if (horseNum <= 10) return 5;
      if (horseNum <= 12) return 6;
      if (horseNum <= 15) return 7;
      return 8;
    }

    /**
     * 馬番の配列から枠番のセットを取得する（重複を除く）
     */
    private getFrameSet(horseNums: number[]): Set<number> {
      const frameSet = new Set<number>();
      horseNums.forEach(horseNum => {
        frameSet.add(this.getFrameNumber(horseNum));
      });
      return frameSet;
    }

    private calculateFormationPoints(betTypeId: string, selectedPositions: number[][]): number {
      if (selectedPositions.length === 0) return 0;

      // 2頭買いの場合（馬連、馬単、枠連、ワイド）
      if (selectedPositions.length === 2) {
        const [first, second] = selectedPositions;
        
        if (betTypeId === 'wakuren') {
          // 枠連：枠番の組み合わせ（順序なし）
          const firstFrames = Array.from(this.getFrameSet(first));
          const secondFrames = Array.from(this.getFrameSet(second));
          let count = 0;
          firstFrames.forEach(f1 => {
            secondFrames.forEach(f2 => {
              if (f1 !== f2) count++;
            });
          });
          return count;
        } else if (betTypeId === 'umaren' || betTypeId === 'wide') {
          // 馬連・ワイド：順序なしの組み合わせ
          // 同じ馬は除き、順序も無視する（(1,2)と(2,1)は同じとみなす）
          // 全頭選択時（18頭）では、18C2=153になる必要がある
          const uniquePairs = new Set<string>();
          first.forEach(f => {
            second.forEach(s => {
              if (f !== s) {
                // 順序を無視するため、小さい方を先に
                const pair = f < s ? `${f},${s}` : `${s},${f}`;
                uniquePairs.add(pair);
              }
            });
          });
          return uniquePairs.size;
        } else if (betTypeId === 'umatan') {
          // 馬単：順序あり（順列）
          // 1着の選択数 × 2着の選択数（同じ馬は選べない）
          // 全頭選択時（18頭）では、18×17=306になる必要がある
          let count = 0;
          first.forEach(f => {
            second.forEach(s => {
              if (f !== s) count++;
            });
          });
          return count;
        }
      }

      // 3頭買いの場合（3連複、3連単）
      if (selectedPositions.length === 3) {
        const [first, second, third] = selectedPositions;
        
        if (betTypeId === 'sanrentan') {
          // 3連単：順序あり（順列）
          // 1着の選択数 × 2着の選択数 × 3着の選択数（同じ馬は選べない）
          // 全頭選択時（18頭）では、18×17×16=4896になる必要がある
          let count = 0;
          first.forEach(f => {
            second.forEach(s => {
              if (f !== s) {
                third.forEach(t => {
                  if (t !== f && t !== s) count++;
                });
              }
            });
          });
          return count;
        } else if (betTypeId === 'sanrenpuku') {
          // 3連複：順序なし（組み合わせ）
          // 同じ馬は除き、順序も無視する（(1,2,3)、(1,3,2)、(2,1,3)などは同じとみなす）
          // 全頭選択時（18頭）では、18C3=816になる必要がある
          const uniqueTriples = new Set<string>();
          first.forEach(f => {
            second.forEach(s => {
              if (f !== s) {
                third.forEach(t => {
                  if (t !== f && t !== s) {
                    // 順序を無視するため、ソートしてから文字列化
                    const triple = [f, s, t].sort((a, b) => a - b).join(',');
                    uniqueTriples.add(triple);
                  }
                });
              }
            });
          });
          return uniqueTriples.size;
        }
      }

      return 0;
    }

    private updateAllCalculations(): void {
      const betTypes = ['wakuren', 'umaren', 'umatan', 'wide', 'sanrenpuku', 'sanrentan'];
      betTypes.forEach(betTypeId => {
        this.calculateForBetType(betTypeId);
      });
    }

    private setupHistorySaving(): void {
      // 選択変更時に履歴保存をスケジュール
      this.container.addEventListener('change', () => {
        this.saveToHistoryDebounced();
      });
    }

    private saveToHistoryDebounced(): void {
      if (this.historySaveTimeout !== null) {
        clearTimeout(this.historySaveTimeout);
      }
      this.historySaveTimeout = window.setTimeout(() => {
        this.saveToHistory();
      }, 2000); // 2秒後に保存
    }

    private saveToHistory(): void {
      // 選択が空の場合は保存しない
      if (this.selections.size === 0) return;

      // 少なくとも1つの着目に選択があることを確認
      let hasSelection = false;
      for (let pos = 1; pos <= 3; pos++) {
        const selection = this.selections.get(pos);
        if (selection && selection.size > 0) {
          hasSelection = true;
          break;
        }
      }

      if (!hasSelection) return;

      // Mapを配列に変換
      const selectionsArray: [number, number[]][] = [];
      this.selections.forEach((horses, position) => {
        if (horses.size > 0) {
          selectionsArray.push([position, Array.from(horses).sort((a, b) => a - b)]);
        }
      });

      const history: CalculationHistory = {
        id: generateHistoryId(),
        type: 'formation',
        timestamp: Date.now(),
        unitAmount: this.unitAmount,
        selections: this.selections
      };

      saveHistory(history);
    }

    private restoreFromCache(): void {
      const history = getHistory();
      if (history.length === 0) return;

      // 最新のフォーメーションの履歴を取得
      const formationHistory = history.find(h => h.type === 'formation');
      if (!formationHistory || !formationHistory.selections) return;

      // Mapを復元（配列の場合はMapに変換）
      let selectionsMap: Map<number, number[]>;
      if (Array.isArray(formationHistory.selections)) {
        selectionsMap = new Map(formationHistory.selections);
      } else if (formationHistory.selections instanceof Map) {
        selectionsMap = formationHistory.selections;
      } else {
        return;
      }

      // 選択を復元
      this.selections.clear();
      selectionsMap.forEach((horses, position) => {
        this.selections.set(position, new Set(horses));
      });

      // 金額を復元
      if (formationHistory.unitAmount && formationHistory.unitAmount > 0) {
        this.unitAmount = formationHistory.unitAmount;
      }

      // UIを更新
      this.updateCheckboxes();
      this.updateAllCalculations();
    }
  }

  // コンポーネントの初期化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFormationCalculators);
  } else {
    initFormationCalculators();
  }

  function initFormationCalculators(): void {
    const calculators = document.querySelectorAll('.formation-calculator');
    calculators.forEach(calculator => {
      new FormationCalculator(calculator as HTMLElement);
    });
  }
</script>

<style>
  .formation-calculator {
    width: 100%;
  }

  .formation-calculator h2 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
  }

  .formation-section {
    width: 100%;
  }

  .formation-table-container {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .table-wrapper {
    width: 100%;
    min-width: 100%;
  }

  .formation-table {
    min-width: 600px;
    width: 100%;
  }

  .formation-table th,
  .formation-table td {
    white-space: nowrap;
  }

  .formation-table tbody tr:hover {
    background-color: #f9fafb;
  }

  .calculation-results {
    width: 100%;
  }

  /* レスポンシブ対応 */
  @media (max-width: 768px) {
    .formation-calculator h2 {
      font-size: 1.25rem;
      margin-bottom: 0.75rem;
    }

    .formation-section {
      padding: 0.75rem;
    }

    .formation-table {
      font-size: 0.8125rem;
      min-width: 500px;
    }

    .formation-table th,
    .formation-table td {
      padding: 0.375rem 0.5rem;
      font-size: 0.75rem;
    }

    .calculation-results {
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.75rem;
    }

    .result-display {
      padding: 0.625rem;
    }
  }

  @media (max-width: 640px) {
    .formation-calculator h2 {
      font-size: 1.125rem;
      margin-bottom: 0.625rem;
    }

    .formation-section {
      padding: 0.625rem;
    }

    .formation-table {
      font-size: 0.75rem;
      min-width: 450px;
    }

    .formation-table th,
    .formation-table td {
      padding: 0.25rem 0.375rem;
      font-size: 0.6875rem;
    }

    .horse-checkbox {
      width: 18px;
      height: 18px;
    }

    .select-all-button,
    .clear-all-button,
    .select-row-button,
    .clear-row-button {
      padding: 0.25rem 0.5rem;
      font-size: 0.6875rem;
      min-height: 32px;
    }

    .calculation-results {
      grid-template-columns: 1fr;
      gap: 0.625rem;
    }

    .result-display {
      padding: 0.5rem;
    }

    .result-display .text-sm {
      font-size: 0.75rem;
    }

    .result-display .text-lg {
      font-size: 1rem;
    }
  }

  @media (max-width: 480px) {
    .formation-table {
      min-width: 400px;
      font-size: 0.6875rem;
    }

    .formation-table th,
    .formation-table td {
      padding: 0.25rem;
      font-size: 0.625rem;
    }

    .horse-checkbox {
      width: 16px;
      height: 16px;
    }
  }

  .horse-checkbox {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    width: 1.25rem;
    height: 1.25rem;
    background-color: #ffffff !important;
    border: 2px solid #d1d5db !important;
    border-radius: 0.25rem;
    cursor: pointer;
    position: relative;
  }

  .horse-checkbox:checked {
    background-color: #ffffff !important;
    border-color: #3b82f6 !important;
  }

  .horse-checkbox:checked::after {
    content: '';
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%) rotate(45deg);
    width: 5px;
    height: 10px;
    border: solid #3b82f6;
    border-width: 0 2px 2px 0;
  }

  /* ダークモードの影響を防ぐ */
  @media (prefers-color-scheme: dark) {
    .horse-checkbox {
      appearance: none !important;
      -webkit-appearance: none !important;
      -moz-appearance: none !important;
      background-color: #ffffff !important;
      border: 2px solid #d1d5db !important;
    }

    .horse-checkbox:checked {
      background-color: #ffffff !important;
      border-color: #3b82f6 !important;
    }

    .horse-checkbox:checked::after {
      border-color: #3b82f6 !important;
    }
  }
</style>
