---
/**
 * WIN5点数計算コンポーネント
 * 5レース×選択頭数を組み合わせた点数と金額を計算
 */
import { formatYenAmountWithKanji } from '../utils/betCalculations';

export interface Props {
  className?: string;
  unitAmount?: number;
}

const { className = '', unitAmount = 100 } = Astro.props;
---

<div class={`win5-calculator ${className}`}>
  <h2 class="text-xl font-bold text-gray-800 mb-4">WIN5の点数計算</h2>
  
  <div class="win5-info mb-6 p-4 bg-white border-2 border-gray-300 rounded-lg">
    <p class="text-sm text-gray-700 mb-2">
      <strong>WIN5について：</strong>5レースの1着馬を組み合わせた馬券です。
    </p>
    <p class="text-sm text-gray-700">
      各レースで選択した頭数を掛け算して合計点数を計算します。
    </p>
  </div>

  <div class="win5-calculation-result p-6 bg-white border-2 border-gray-300 rounded-lg">
    <div class="calculation-details mb-6">
      <div class="race-calculations flex flex-col gap-3 mb-6">
        {Array.from({ length: 5 }, (_, i) => {
          const raceNum = i + 1;
          return (
            <div class="race-item p-4 bg-gray-50 border border-gray-200 rounded-lg">
              <div class="flex items-center justify-between gap-3">
                <div class="flex items-center gap-3 flex-1">
                  <label for={`race-${raceNum}-select`} class="text-base font-semibold text-gray-700 whitespace-nowrap">
                    {raceNum}レース目
                  </label>
                  <select
                    id={`race-${raceNum}-select`}
                    data-race-num={raceNum}
                    class="race-select w-24 px-3 py-2 border-2 border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                    aria-label={`${raceNum}レース目の選択頭数`}
                  >
                    {Array.from({ length: 18 }, (_, j) => {
                      const count = j + 1;
                      return (
                        <option value={count} selected={count === 1}>
                          {count}頭
                        </option>
                      );
                    })}
                  </select>
                </div>
                <div class="text-right flex-shrink-0">
                  <div class="text-xs text-gray-600 mb-1">点数</div>
                  <div class="text-lg font-bold text-blue-600 race-points" data-race-num={raceNum}>
                    1点
                  </div>
                </div>
              </div>
            </div>
          );
        })}
      </div>
    </div>

    <div class="total-calculation p-4 bg-gradient-to-r from-blue-50 to-green-50 border-2 border-blue-300 rounded-lg">
      <div class="flex items-center justify-between gap-2 md:gap-4 flex-wrap">
        <div class="total-points flex-1 min-w-0">
          <div class="text-xs md:text-sm text-gray-600 mb-1">合計点数</div>
          <div class="flex items-center gap-1 md:gap-2 flex-wrap">
            <div class="text-sm md:text-xl font-medium text-gray-700 whitespace-nowrap" id="win5-calculation-formula">
              1×1×1×1×1
            </div>
            <div class="text-gray-500">=</div>
            <div class="text-lg md:text-3xl font-bold text-blue-600 whitespace-nowrap" id="win5-total-points">
              1点
            </div>
          </div>
        </div>
        <div class="total-amount text-right flex-shrink-0">
          <div class="text-xs md:text-sm text-gray-600 mb-1">合計金額（1点100円）</div>
          <div class="text-lg md:text-3xl font-bold text-green-600 whitespace-nowrap" id="win5-total-amount">
            100円
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  /**
   * 金額を漢字の単位（万円、億円など）で表示する
   */
  function formatYenAmountWithKanjiClient(amount: number): string {
    if (amount === 0) {
      return "0円";
    }

    const oku = Math.floor(amount / 100000000);
    const man = Math.floor((amount % 100000000) / 10000);
    const yen = amount % 10000;

    const parts: string[] = [];

    if (oku > 0) {
      parts.push(`${oku}億円`);
    }
    if (man > 0) {
      parts.push(`${man}万円`);
    }
    if (yen > 0 || parts.length === 0) {
      parts.push(`${yen}円`);
    }

    return parts.join('');
  }

  // historyStorageの関数をインポート（クライアント側で使用）
  // 注意: Astroの<script>タグ内では直接importできないため、関数を直接定義
  interface CalculationHistory {
    id: string;
    type: 'box' | 'formation' | 'win5';
    timestamp: number;
    horseCount?: number;
    unitAmount: number;
    selections?: Map<number, number[]>;
    raceHorseCounts?: number[];
    results?: {
      betTypeId: string;
      points: number;
      totalAmount: number;
    }[];
  }

  const STORAGE_KEY = 'horse-racing-calc-history';
  const MAX_HISTORY_COUNT = 50;

  function getHistory(): CalculationHistory[] {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (!stored) return [];
      
      const history = JSON.parse(stored);
      return history.map((item: any) => {
        if (item.selections && Array.isArray(item.selections)) {
          const selectionsMap = new Map<number, number[]>();
          item.selections.forEach(([pos, horses]: [number, number[]]) => {
            selectionsMap.set(pos, horses);
          });
          item.selections = selectionsMap;
        }
        return item;
      });
    } catch (error) {
      console.error('履歴の読み込みに失敗しました:', error);
      return [];
    }
  }

  function saveHistory(history: CalculationHistory): void {
    try {
      const allHistory = getHistory();
      
      // 新しい履歴を先頭に追加
      allHistory.unshift(history);
      
      // 最大件数を超えた場合は古いものを削除
      if (allHistory.length > MAX_HISTORY_COUNT) {
        allHistory.splice(MAX_HISTORY_COUNT);
      }
      
      // Mapを配列に変換して保存
      const serialized = allHistory.map(item => {
        const serializedItem: any = { ...item };
        if (item.selections instanceof Map) {
          serializedItem.selections = Array.from(item.selections.entries());
        }
        return serializedItem;
      });
      
      localStorage.setItem(STORAGE_KEY, JSON.stringify(serialized));
    } catch (error) {
      console.error('履歴の保存に失敗しました:', error);
    }
  }

  function generateHistoryId(): string {
    return `calc_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  }

  class Win5Calculator {
    private container: HTMLElement;
    private raceSelects: NodeListOf<HTMLSelectElement>;
    private totalPointsDisplay: HTMLElement | null;
    private totalAmountDisplay: HTMLElement | null;
    private calculationFormulaDisplay: HTMLElement | null;
    private racePointsDisplays: NodeListOf<HTMLElement>;
    private unitAmount: number = 100;
    // パフォーマンス最適化: 計算結果のキャッシュとバッチ処理
    private racePointsMap: Map<number, HTMLElement> = new Map();
    private updateFrameId: number | null = null;

    constructor(container: HTMLElement) {
      this.container = container;
      this.raceSelects = container.querySelectorAll('.race-select');
      this.totalPointsDisplay = container.querySelector('#win5-total-points');
      this.totalAmountDisplay = container.querySelector('#win5-total-amount');
      this.calculationFormulaDisplay = container.querySelector('#win5-calculation-formula');
      this.racePointsDisplays = container.querySelectorAll('.race-points');
      
      // レース点数表示をマップにキャッシュ
      this.racePointsDisplays.forEach(display => {
        const raceNum = display.getAttribute('data-race-num');
        if (raceNum) {
          this.racePointsMap.set(parseInt(raceNum, 10), display);
        }
      });
      
      this.init();
    }

    private init(): void {
      // 金額変更イベントをリッスン
      document.addEventListener('amountChange', (event: any) => {
        if (event.detail && typeof event.detail.amount === 'number') {
          this.unitAmount = event.detail.amount;
          this.calculate();
        }
      });

      // 各セレクトボックスの変更イベントを設定
      this.raceSelects.forEach((select) => {
        select.addEventListener('change', () => {
          this.calculate();
          this.saveToHistory();
        });
      });

      // キャッシュから復元
      this.restoreFromCache();

      // 初期計算
      this.calculate();
    }

    private calculate(): void {
      // requestAnimationFrameでバッチ処理
      if (this.updateFrameId !== null) {
        cancelAnimationFrame(this.updateFrameId);
      }
      
      this.updateFrameId = requestAnimationFrame(() => {
        this.calculateImmediate();
        this.updateFrameId = null;
      });
    }

    private calculateImmediate(): void {
      // 各レースの選択頭数を取得
      const horseCounts: number[] = [];
      this.raceSelects.forEach((select) => {
        const count = parseInt(select.value, 10);
        horseCounts.push(count);
        
        // 各レースの点数を更新（キャッシュから取得）
        const raceNum = parseInt(select.getAttribute('data-race-num') || '0', 10);
        const racePointsDisplay = this.racePointsMap.get(raceNum);
        if (racePointsDisplay) {
          racePointsDisplay.textContent = `${count}点`;
        }
      });

      // 合計点数を計算（掛け算）
      const totalPoints = horseCounts.reduce((acc, count) => acc * count, 1);

      // 合計金額を計算（1点100円）
      const totalAmount = totalPoints * this.unitAmount;

      // 計算式を生成
      const formula = horseCounts.map(count => count.toString()).join('×');

      // 表示を更新
      if (this.calculationFormulaDisplay) {
        this.calculationFormulaDisplay.textContent = formula;
      }

      if (this.totalPointsDisplay) {
        this.totalPointsDisplay.textContent = `${totalPoints.toLocaleString('ja-JP')}点`;
      }

      if (this.totalAmountDisplay) {
        this.totalAmountDisplay.textContent = formatYenAmountWithKanjiClient(totalAmount);
      }
    }

    private saveToHistory(): void {
      // 各レースの選択頭数を取得
      const raceHorseCounts: number[] = [];
      this.raceSelects.forEach((select) => {
        const count = parseInt(select.value, 10);
        raceHorseCounts.push(count);
      });

      // すべて1頭の場合は保存しない（初期状態）
      if (raceHorseCounts.every(count => count === 1)) {
        return;
      }

      const history: CalculationHistory = {
        id: generateHistoryId(),
        type: 'win5',
        timestamp: Date.now(),
        unitAmount: this.unitAmount,
        raceHorseCounts: raceHorseCounts
      };

      try {
        saveHistory(history);
        console.log('[WIN5] 履歴を保存:', history);
      } catch (error) {
        console.error('[WIN5] 履歴の保存に失敗:', error);
      }
    }

    private restoreFromCache(): void {
      try {
        const history = getHistory();
        if (history.length === 0) {
          console.log('[WIN5] 履歴がありません');
          return;
        }

        // 最新のWIN5の履歴を取得
        const win5History = history.find(h => h.type === 'win5');
        if (!win5History || !win5History.raceHorseCounts) {
          console.log('[WIN5] WIN5の履歴がありません');
          return;
        }

        console.log('[WIN5] 履歴を復元:', win5History);

        // 各レースの選択頭数を復元
        const raceHorseCounts = win5History.raceHorseCounts;
        if (raceHorseCounts.length === 5) {
          this.raceSelects.forEach((select, index) => {
            if (index < raceHorseCounts.length) {
              const count = raceHorseCounts[index];
              if (count >= 1 && count <= 18) {
                select.value = count.toString();
              }
            }
          });
        }

        // 金額を復元
        if (win5History.unitAmount && win5History.unitAmount > 0) {
          this.unitAmount = win5History.unitAmount;
          console.log('[WIN5] 金額を復元:', this.unitAmount);
        }

        console.log('[WIN5] 選択を復元:', raceHorseCounts);
      } catch (error) {
        console.error('[WIN5] 履歴の復元に失敗:', error);
      }
    }
  }

  // コンポーネントの初期化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initWin5Calculator);
  } else {
    initWin5Calculator();
  }

  function initWin5Calculator(): void {
    const calculators = document.querySelectorAll('.win5-calculator');
    calculators.forEach((calc) => {
      new Win5Calculator(calc as HTMLElement);
    });
  }
</script>

<style>
  .win5-calculator {
    width: 100%;
  }

  .race-item {
    transition: all 0.2s ease-in-out;
  }

  .race-item:hover {
    background-color: #f3f4f6;
    transform: translateY(-2px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .total-calculation {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  /* レスポンシブ対応 */
  @media (max-width: 768px) {
    .win5-calculator h2 {
      font-size: 1.25rem;
      margin-bottom: 0.75rem;
    }

    .total-calculation {
      padding: 0.75rem;
    }

    .total-calculation .text-lg {
      font-size: 1rem;
    }
  }

  @media (max-width: 640px) {
    .win5-calculator h2 {
      font-size: 1.125rem;
    }

    .win5-info {
      padding: 0.75rem;
      font-size: 0.8125rem;
    }

    .race-item {
      padding: 0.75rem;
    }

    .race-item label {
      font-size: 0.875rem;
    }

    .race-select {
      font-size: 0.8125rem;
      padding: 0.5rem 0.75rem;
    }

    .race-item .race-points {
      font-size: 1rem;
    }

    .total-calculation .text-3xl {
      font-size: 1.25rem;
    }
  }
</style>

