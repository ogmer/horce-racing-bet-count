---
/**
 * 点数表タブコンポーネント
 * 早見表、BOX点数表、フォーメーション、履歴の4つのタブを切り替える
 */
import QuickReferenceTable from './QuickReferenceTable.astro';
import AllBetTypesPointsDisplay from './AllBetTypesPointsDisplay.astro';
import FormationCalculator from './FormationCalculator.astro';
import { DEFAULT_AMOUNT } from '../utils/betCalculations';

export interface Props {
  horseCount?: number;
  unitAmount?: number;
  className?: string;
}

const { 
  horseCount = 1, 
  unitAmount = DEFAULT_AMOUNT,
  className = '' 
} = Astro.props;
---

<div class={`points-table-tabs ${className}`}>
  <!-- タブヘッダー -->
  <nav class="tabs-header mb-6" role="tablist" aria-label="計算ツールの切り替え">
    <div class="flex border-b border-gray-200">
      <button
        type="button"
        id="tab-quick-reference"
        role="tab"
        aria-controls="content-quick-reference"
        aria-selected="true"
        class="tab-button active px-6 py-3 text-sm font-medium border-b-2 border-blue-500 text-blue-600 transition-all duration-200"
      >
        早見表
      </button>
      <button
        type="button"
        id="tab-box-points"
        role="tab"
        aria-controls="content-box-points"
        aria-selected="false"
        class="tab-button px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition-all duration-200"
      >
        BOX点数表
      </button>
      <button
        type="button"
        id="tab-formation"
        role="tab"
        aria-controls="content-formation"
        aria-selected="false"
        class="tab-button px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition-all duration-200"
      >
        フォーメーション
      </button>
    </div>
  </nav>

  <!-- タブコンテンツ -->
  <div class="tabs-content">
    <!-- 早見表タブ -->
    <div id="content-quick-reference" class="tab-content" role="tabpanel" aria-labelledby="tab-quick-reference">
      <QuickReferenceTable />
    </div>

    <!-- BOX点数表タブ -->
    <div id="content-box-points" class="tab-content hidden" role="tabpanel" aria-labelledby="tab-box-points">
      <AllBetTypesPointsDisplay 
        className="w-full"
        horseCount={horseCount}
        unitAmount={unitAmount}
      />
    </div>

    <!-- フォーメーションタブ -->
    <div id="content-formation" class="tab-content hidden" role="tabpanel" aria-labelledby="tab-formation">
      <FormationCalculator 
        className="w-full"
        unitAmount={unitAmount}
      />
    </div>
  </div>
</div>

<script>
  class PointsTableTabs {
    private container: HTMLElement;
    private tabButtons: NodeListOf<HTMLButtonElement>;
    private tabContents: NodeListOf<HTMLElement>;
    private horseCount: number = 0;
    private unitAmount: number = 100;

    constructor(container: HTMLElement) {
      this.container = container;
      this.tabButtons = container.querySelectorAll('.tab-button');
      this.tabContents = container.querySelectorAll('.tab-content');
      this.init();
    }

    private init(): void {
      this.tabButtons.forEach((button, index) => {
        button.addEventListener('click', () => {
          this.switchTab(index);
        });
      });

      // イベントリスナーを設定（bindでメソッドを最適化）
      this.container.addEventListener('horseCountChange', this.handleHorseCountChange.bind(this));
      document.addEventListener('amountChange', this.handleAmountChange.bind(this));
      
      // キーボードショートカットを設定
      this.setupKeyboardShortcuts();
    }

    private setupKeyboardShortcuts(): void {
      document.addEventListener('keydown', (event: KeyboardEvent) => {
        // 入力フィールドにフォーカスがある場合は無視
        const target = event.target as HTMLElement;
        if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA') {
          return;
        }

        // Ctrl+1/2/3 または Alt+1/2/3 でタブ切り替え
        if ((event.ctrlKey || event.altKey) && event.key >= '1' && event.key <= '3') {
          event.preventDefault();
          const tabIndex = parseInt(event.key) - 1;
          if (tabIndex < this.tabButtons.length) {
            this.switchTab(tabIndex);
          }
        }
      });
    }

    private handleHorseCountChange(event: Event): void {
      const customEvent = event as CustomEvent;
      if (customEvent.detail) {
        this.horseCount = customEvent.detail.horseCount || 1;
      }
    }

    private handleAmountChange(event: Event): void {
      const customEvent = event as CustomEvent;
      if (customEvent.detail && typeof customEvent.detail.amount === 'number') {
        this.unitAmount = customEvent.detail.amount;
      }
    }

    private switchTab(index: number): void {
      // すべてのタブボタンのアクティブ状態を解除
      this.tabButtons.forEach((btn, i) => {
        btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
        btn.classList.add('border-transparent', 'text-gray-500');
        btn.setAttribute('aria-selected', 'false');
      });

      // すべてのタブコンテンツを非表示
      this.tabContents.forEach(content => {
        content.classList.add('hidden');
      });

      // 選択されたタブをアクティブに
      const selectedButton = this.tabButtons[index];
      const selectedContent = this.tabContents[index];

      if (selectedButton && selectedContent) {
        selectedButton.classList.add('active', 'border-blue-500', 'text-blue-600');
        selectedButton.classList.remove('border-transparent', 'text-gray-500');
        selectedButton.setAttribute('aria-selected', 'true');
        selectedContent.classList.remove('hidden');
      }
    }
  }

  // コンポーネントの初期化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPointsTableTabs);
  } else {
    initPointsTableTabs();
  }

  function initPointsTableTabs(): void {
    const tabs = document.querySelectorAll('.points-table-tabs');
    tabs.forEach(tab => {
      new PointsTableTabs(tab as HTMLElement);
    });
  }
</script>

<style>
  .tab-button {
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    min-height: 44px; /* タッチターゲットサイズ */
  }

  .tab-button:hover {
    color: #2563eb;
  }

  .tab-button.active {
    font-weight: 600;
  }

  .tab-content {
    animation: fadeIn 0.3s ease-in-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* レスポンシブ対応 */
  @media (max-width: 768px) {
    .tabs-header .flex {
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .tabs-header .flex::-webkit-scrollbar {
      display: none;
    }

    .tab-button {
      padding: 0.75rem 1rem;
      font-size: 0.875rem;
      white-space: nowrap;
      flex-shrink: 0;
    }
  }

  @media (max-width: 640px) {
    .tab-button {
      padding: 0.625rem 0.875rem;
      font-size: 0.8125rem;
    }
  }
</style>

